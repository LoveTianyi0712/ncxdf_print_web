# Cookies配置管理指南

## 功能概述

为了解决ERP系统认证cookies过期导致的学员查询失败问题，系统新增了Cookies配置管理功能。管理员可以通过网页界面更新和管理认证cookies，无需修改代码。

## 主要特性

- 🔐 **网页管理**：管理员可在网页端直接更新cookies配置
- 🧪 **配置测试**：支持测试cookies配置是否有效
- 🔄 **多配置管理**：支持保存多个配置，灵活切换
- ⚠️ **智能提醒**：API失败时自动提醒管理员更新配置
- 📱 **用户友好**：普通用户看到友好的错误提示

## 使用方法

### 1. 访问配置页面

管理员登录后，在左侧导航栏中点击 **"Cookies配置"** 进入管理页面。

### 2. 获取新的Cookies

1. 在浏览器中登录ERP系统（https://erp.xdf.cn）
2. 按 `F12` 打开开发者工具
3. 切换到 `Network` 标签页
4. 刷新页面或执行任意操作，找到任意一个API请求
5. 点击请求，在 `Request Headers` 中找到 `Cookie` 字段
6. 复制Cookie字段的完整值

### 3. 添加新配置

1. 点击 **"添加新配置"** 按钮
2. 输入配置名称（如："2025年1月配置"）
3. 将复制的Cookie值粘贴到文本框中

系统支持多种格式：

**JSON格式：**
```json
{
  "FE_USER_CODE": "NC24048S6UzC",
  "FE_USER_NAME": "%E5%BC%A0%E8%B0%A6235",
  "rem": "on"
}
```

**键值对格式（换行分隔）：**
```
FE_USER_CODE=NC24048S6UzC
FE_USER_NAME=%E5%BC%A0%E8%B0%A6235
rem=on
```

**键值对格式（分号分隔）：**
```
FE_USER_CODE=NC24048S6UzC; FE_USER_NAME=%E5%BC%A0%E8%B0%A6235; rem=on
```

### 4. 测试配置

保存配置后，点击 **测试按钮** (🧪) 验证配置是否有效：

- ✅ **成功**：配置可以正常连接ERP系统
- ❌ **失败**：配置已过期或无效，需要更新

### 5. 激活配置

如果有多个配置，点击 **激活按钮** (✓) 将指定配置设为当前使用的配置。

## 错误处理

### 用户侧错误提示

当学员查询失败时：

- **普通用户**：看到 "请联系管理员更新系统认证配置" 的提示
- **管理员**：看到 "请前往Cookies配置页面更新认证信息" 的提示，并提供直接跳转链接

### 常见问题解决

1. **"API调用失败"错误**
   - 原因：当前cookies已过期或无效
   - 解决：管理员更新cookies配置

2. **"未找到该学员"错误**
   - 原因：学员确实不存在（正常情况）
   - 解决：检查学员编码是否正确

3. **配置测试失败**
   - 原因：cookies格式错误或已过期
   - 解决：重新获取最新的cookies并更新配置

## 安全注意事项

⚠️ **重要提醒**：

1. Cookies包含敏感的认证信息，请妥善保管
2. 定期更新cookies配置以确保系统正常运行
3. 不要与非管理员用户分享cookies内容
4. 建议每月检查并更新一次配置

## 技术细节

### 数据存储

- 配置存储在数据库的 `cookies_config` 表中
- cookies数据以JSON格式加密存储
- 支持配置历史记录和测试状态跟踪

### API集成

- 系统自动从数据库读取活跃的cookies配置
- 当配置失效时，自动降级到默认配置
- 支持实时配置切换，无需重启服务

## 维护建议

1. **定期检查**：建议每月检查配置状态
2. **备份配置**：保留多个有效配置作为备份
3. **监控日志**：关注系统日志中的认证失败记录
4. **及时更新**：发现配置失效后立即更新

---

如有问题，请联系技术支持或查看系统日志获取更多详细信息。 