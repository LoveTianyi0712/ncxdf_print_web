{% extends "base.html" %}

{% block title %}æ‰“å°å‡­è¯ - å—æ˜Œæ–°ä¸œæ–¹å‡­è¯æ‰“å°ç³»ç»Ÿ{% endblock %}

{% block content %}
<!-- ç§»åŠ¨ç«¯é¡µé¢æ ‡é¢˜ -->
<div class="d-flex justify-content-between align-items-center pt-2 pb-2 mb-3 border-bottom">
    <h4 class="mb-0">æ‰“å°å‡­è¯</h4>
    <div class="d-none d-md-block">
        <small class="text-muted">è¯·è¾“å…¥å­¦å‘˜ç¼–ç æŸ¥è¯¢</small>
    </div>
</div>

<!-- ç§»åŠ¨ç«¯å¸ƒå±€ -->
<div class="mobile-print-container">
    <!-- å­¦å‘˜æŸ¥è¯¢å¡ç‰‡ -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h6 class="card-title mb-0">
                <i class="fas fa-search me-2"></i>å­¦å‘˜æŸ¥è¯¢
            </h6>
        </div>
        <div class="card-body">
            <form id="searchForm">
                <div class="input-group">
                    <input type="text" class="form-control form-control-lg" id="studentCode" 
                           placeholder="è¾“å…¥å­¦å‘˜ç¼–ç " required autocomplete="off">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="form-text mt-2">
                    <small>ç¤ºä¾‹ï¼šNC6080119755 æˆ– NC6080119756</small>
                </div>
            </form>
            
            <!-- å­¦å‘˜ä¿¡æ¯æ˜¾ç¤º -->
            <div id="studentInfo" class="mt-3" style="display: none;">
                <div class="alert alert-success border-0 rounded-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-user-check text-success me-2"></i>
                        <h6 class="mb-0">å­¦å‘˜ä¿¡æ¯</h6>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">å§“å</small>
                            <div class="fw-bold" id="studentName"></div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">æ€§åˆ«</small>
                            <div id="studentGender"></div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">å­¦å‘˜ç¼–ç </small>
                        <div class="font-monospace" id="studentCodeDisplay"></div>
                    </div>
                </div>
            </div>
            
            <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤º -->
            <div id="errorMessage" class="mt-3" style="display: none;">
                <div class="alert alert-danger border-0 rounded-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-circle text-danger me-2"></i>
                        <span id="errorText"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¯æ‰“å°å‡­è¯åˆ—è¡¨ -->
    <div class="card mb-3" id="reportsCard" style="display: none;">
        <div class="card-header bg-info text-white">
            <h6 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>å¯æ‰“å°å‡­è¯
            </h6>
        </div>
        <div class="card-body p-2">
            <div id="reportsList">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å‡­è¯åˆ—è¡¨ -->
            </div>
        </div>
    </div>
    
    <!-- æ‰“å°é¢„è§ˆ -->
    <div class="card" id="previewCard" style="display: none;">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">
                <i class="fas fa-eye me-2"></i>æ‰“å°é¢„è§ˆ
            </h6>
            <div class="btn-group" role="group">
                <button id="generateBtn" class="btn btn-light btn-sm" disabled>
                    <i class="fas fa-print me-1"></i>ç”Ÿæˆ
                </button>
                <button id="downloadBtn" class="btn btn-light btn-sm" style="display: none;">
                    <i class="fas fa-download me-1"></i>ä¸‹è½½
                </button>
            </div>
        </div>
        <div class="card-body p-2">
            <div id="printPreview" class="text-center">
                <div class="py-4">
                    <i class="fas fa-file-alt fa-3x text-muted mb-2"></i>
                    <p class="text-muted mb-0">è¯·é€‰æ‹©è¦æ‰“å°çš„å‡­è¯</p>
                </div>
            </div>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">ç”Ÿæˆä¸­...</span>
                </div>
                <p class="text-muted mb-0">æ­£åœ¨ç”Ÿæˆæ‰“å°é¢„è§ˆ...</p>
            </div>
        </div>
    </div>
    
    <!-- ç§»åŠ¨ç«¯å¿«é€Ÿæ“ä½œæ  -->
    <div class="mobile-action-bar d-md-none" style="display: none;" id="mobileActionBar">
        <div class="container-fluid">
            <div class="row g-2">
                <div class="col-4">
                    <button class="btn btn-outline-primary w-100 btn-sm" onclick="scrollToTop()">
                        <i class="fas fa-arrow-up"></i>
                        <small class="d-block">è¿”å›é¡¶éƒ¨</small>
                    </button>
                </div>
                <div class="col-4">
                    <button id="mobileGenerateBtn" class="btn btn-success w-100 btn-sm" disabled>
                        <i class="fas fa-print"></i>
                        <small class="d-block">ç”Ÿæˆæ‰“å°</small>
                    </button>
                </div>
                <div class="col-4">
                    <button id="mobileDownloadBtn" class="btn btn-secondary w-100 btn-sm" style="display: none;">
                        <i class="fas fa-download"></i>
                        <small class="d-block">ä¸‹è½½å›¾ç‰‡</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ¡Œé¢ç«¯å¸ƒå±€ï¼ˆä¿æŒåŸæœ‰å¸ƒå±€ï¼‰ -->
<div class="row d-none d-md-flex">
    <!-- å·¦ä¾§ï¼šå­¦å‘˜æŸ¥è¯¢ -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-search me-2"></i>å­¦å‘˜æŸ¥è¯¢
                </h5>
            </div>
            <div class="card-body">
                <form id="desktopSearchForm">
                    <div class="mb-3">
                        <label for="desktopStudentCode" class="form-label">å­¦å‘˜ç¼–ç </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="desktopStudentCode" placeholder="è¾“å…¥å­¦å‘˜ç¼–ç " required>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            ç¤ºä¾‹ï¼šNC6080119755 æˆ– NC6080119756
                        </div>
                    </div>
                </form>
                
                <!-- æ¡Œé¢ç«¯å­¦å‘˜ä¿¡æ¯æ˜¾ç¤º -->
                <div id="desktopStudentInfo" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <h6 class="alert-heading">å­¦å‘˜ä¿¡æ¯</h6>
                        <p class="mb-2"><strong>å§“åï¼š</strong><span id="desktopStudentName"></span></p>
                        <p class="mb-2"><strong>æ€§åˆ«ï¼š</strong><span id="desktopStudentGender"></span></p>
                        <p class="mb-0"><strong>ç¼–ç ï¼š</strong><span id="desktopStudentCodeDisplay"></span></p>
                    </div>
                </div>
                
                <!-- æ¡Œé¢ç«¯é”™è¯¯ä¿¡æ¯æ˜¾ç¤º -->
                <div id="desktopErrorMessage" class="mt-3" style="display: none;">
                    <div class="alert alert-danger">
                        <span id="desktopErrorText"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¡Œé¢ç«¯å¯æ‰“å°å‡­è¯åˆ—è¡¨ -->
        <div class="card mt-3" id="desktopReportsCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>å¯æ‰“å°å‡­è¯
                </h5>
            </div>
            <div class="card-body">
                <div id="desktopReportsList">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„å‡­è¯åˆ—è¡¨ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§ï¼šæ‰“å°é¢„è§ˆ -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-eye me-2"></i>æ‰“å°é¢„è§ˆ
                </h5>
                <div>
                    <button id="desktopGenerateBtn" class="btn btn-success" disabled>
                        <i class="fas fa-print me-1"></i>ç”Ÿæˆæ‰“å°
                    </button>
                    <button id="desktopDownloadBtn" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-download me-1"></i>ä¸‹è½½å›¾ç‰‡
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="desktopPrintPreview" class="text-center">
                    <div class="py-5">
                        <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                        <p class="text-muted">è¯·å…ˆæŸ¥è¯¢å­¦å‘˜ä¿¡æ¯å¹¶é€‰æ‹©è¦æ‰“å°çš„å‡­è¯</p>
                    </div>
                </div>
                
                <!-- æ¡Œé¢ç«¯åŠ è½½çŠ¶æ€ -->
                <div id="desktopLoadingSpinner" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ç”Ÿæˆä¸­...</span>
                    </div>
                    <p class="mt-2 text-muted">æ­£åœ¨ç”Ÿæˆæ‰“å°é¢„è§ˆï¼Œè¯·ç¨å€™...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// æ£€æµ‹è®¾å¤‡ç±»å‹å¹¶ä½¿ç”¨ç›¸åº”çš„å…ƒç´ 
const isMobile = window.innerWidth <= 768;
let currentStudentData = null;
let selectedReport = null;

// ç»Ÿä¸€çš„å…ƒç´ é€‰æ‹©å™¨
const elements = {
    // æŸ¥è¯¢è¡¨å•
    searchForm: isMobile ? '#searchForm' : '#desktopSearchForm',
    studentCode: isMobile ? '#studentCode' : '#desktopStudentCode',
    
    // å­¦å‘˜ä¿¡æ¯æ˜¾ç¤º
    studentInfo: isMobile ? '#studentInfo' : '#desktopStudentInfo',
    studentName: isMobile ? '#studentName' : '#desktopStudentName',
    studentGender: isMobile ? '#studentGender' : '#desktopStudentGender',
    studentCodeDisplay: isMobile ? '#studentCodeDisplay' : '#desktopStudentCodeDisplay',
    
    // é”™è¯¯ä¿¡æ¯
    errorMessage: isMobile ? '#errorMessage' : '#desktopErrorMessage',
    errorText: isMobile ? '#errorText' : '#desktopErrorText',
    
    // å‡­è¯åˆ—è¡¨
    reportsCard: isMobile ? '#reportsCard' : '#desktopReportsCard',
    reportsList: isMobile ? '#reportsList' : '#desktopReportsList',
    
    // æ‰“å°é¢„è§ˆ
    printPreview: isMobile ? '#printPreview' : '#desktopPrintPreview',
    loadingSpinner: isMobile ? '#loadingSpinner' : '#desktopLoadingSpinner',
    generateBtn: isMobile ? '#generateBtn' : '#desktopGenerateBtn',
    downloadBtn: isMobile ? '#downloadBtn' : '#desktopDownloadBtn'
};

// æŸ¥è¯¢å­¦å‘˜ä¿¡æ¯
document.querySelector(elements.searchForm).addEventListener('submit', function(e) {
    e.preventDefault();
    const studentCode = document.querySelector(elements.studentCode).value.trim();
    
    if (!studentCode) {
        showError('è¯·è¾“å…¥å­¦å‘˜ç¼–ç ');
        return;
    }
    
    fetch(`/search_student?student_code=${encodeURIComponent(studentCode)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                hideStudentInfo();
            } else {
                showStudentInfo(data, studentCode);
                showReports(data.reports);
                
                // ç§»åŠ¨ç«¯æ˜¾ç¤ºé¢„è§ˆå¡ç‰‡
                if (isMobile) {
                    document.getElementById('previewCard').style.display = 'block';
                    document.getElementById('mobileActionBar').style.display = 'block';
                }
            }
        })
        .catch(error => {
            showError('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·é‡è¯•');
            console.error('Error:', error);
        });
});

// æ˜¾ç¤ºå­¦å‘˜ä¿¡æ¯
function showStudentInfo(data, studentCode) {
    document.querySelector(elements.studentName).textContent = data.student_name;
    document.querySelector(elements.studentGender).textContent = data.gender;
    document.querySelector(elements.studentCodeDisplay).textContent = studentCode;
    document.querySelector(elements.studentInfo).style.display = 'block';
    document.querySelector(elements.errorMessage).style.display = 'none';
    
    currentStudentData = data;
}

// éšè—å­¦å‘˜ä¿¡æ¯
function hideStudentInfo() {
    document.querySelector(elements.studentInfo).style.display = 'none';
    document.querySelector(elements.reportsCard).style.display = 'none';
    if (isMobile) {
        document.getElementById('previewCard').style.display = 'none';
        document.getElementById('mobileActionBar').style.display = 'none';
    }
    resetPreview();
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    document.querySelector(elements.errorText).textContent = message;
    document.querySelector(elements.errorMessage).style.display = 'block';
    document.querySelector(elements.studentInfo).style.display = 'none';
    document.querySelector(elements.reportsCard).style.display = 'none';
    if (isMobile) {
        document.getElementById('previewCard').style.display = 'none';
        document.getElementById('mobileActionBar').style.display = 'none';
    }
    resetPreview();
}

// æ˜¾ç¤ºå¯æ‰“å°å‡­è¯åˆ—è¡¨
function showReports(reports) {
    const reportsList = document.querySelector(elements.reportsList);
    reportsList.innerHTML = '';
    
    reports.forEach(report => {
        const reportItem = document.createElement('div');
        reportItem.className = isMobile ? 'mb-2' : 'mb-2';
        
        // ç§»åŠ¨ç«¯ç®€åŒ–æ˜¾ç¤º
        let buttonContent = isMobile ? 
        `
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="fas fa-file-alt me-2 text-primary"></i>
                    <div>
                        <div class="fw-bold">${report.biz_name}</div>
                        ${report.description ? `<small class="text-muted">${report.description}</small>` : ''}
                    </div>
                </div>
                <i class="fas fa-chevron-right text-muted"></i>
            </div>
        ` :
        `
            <div class="d-flex align-items-center">
                <i class="fas fa-file-alt me-2"></i>
                <div class="flex-grow-1">
                    <div class="fw-bold">${report.biz_name}</div>
                    ${report.description ? `<small class="text-muted">${report.description}</small>` : ''}
                </div>
            </div>
        `;
        
        reportItem.innerHTML = `
            <button class="btn btn-outline-primary w-100 ${isMobile ? 'text-start py-3' : 'text-start'} report-btn" 
                    data-biz-type="${report.biz_type}" 
                    data-report='${JSON.stringify(report)}'>
                ${buttonContent}
            </button>
        `;
        reportsList.appendChild(reportItem);
    });
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.report-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.report-btn').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline-primary');
            });
            
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary');
            
            // ä¿å­˜é€‰ä¸­çš„æŠ¥å‘Š
            selectedReport = JSON.parse(this.dataset.report);
            
            // å¯ç”¨ç”ŸæˆæŒ‰é’®
            document.querySelector(elements.generateBtn).disabled = false;
            if (isMobile) {
                document.getElementById('mobileGenerateBtn').disabled = false;
            }
            
            console.log('é€‰ä¸­å‡­è¯:', selectedReport);
        });
    });
    
    document.querySelector(elements.reportsCard).style.display = 'block';
}

// é‡ç½®é¢„è§ˆ
function resetPreview() {
    const previewElement = document.querySelector(elements.printPreview);
    previewElement.innerHTML = isMobile ? 
        `<div class="py-4">
            <i class="fas fa-file-alt fa-3x text-muted mb-2"></i>
            <p class="text-muted mb-0">è¯·é€‰æ‹©è¦æ‰“å°çš„å‡­è¯</p>
        </div>` :
        `<div class="py-5">
            <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
            <p class="text-muted">è¯·å…ˆæŸ¥è¯¢å­¦å‘˜ä¿¡æ¯å¹¶é€‰æ‹©è¦æ‰“å°çš„å‡­è¯</p>
        </div>`;
    
    document.querySelector(elements.generateBtn).disabled = true;
    document.querySelector(elements.downloadBtn).style.display = 'none';
    
    if (isMobile) {
        document.getElementById('mobileGenerateBtn').disabled = true;
        document.getElementById('mobileDownloadBtn').style.display = 'none';
    }
    
    selectedReport = null;
}

// ç”Ÿæˆæ‰“å°é¢„è§ˆ
function generatePrint() {
    if (!selectedReport || !currentStudentData) {
        alert('è¯·å…ˆé€‰æ‹©è¦æ‰“å°çš„å‡­è¯');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.querySelector(elements.loadingSpinner).style.display = 'block';
    document.querySelector(elements.printPreview).style.display = 'none';
    
    // æ„å»ºè¯·æ±‚æ•°æ®
    const requestData = {
        student_code: document.querySelector(elements.studentCode).value.trim(),
        biz_type: selectedReport.biz_type,
        student_data: currentStudentData
    };
    
    fetch('/generate_print_preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        document.querySelector(elements.loadingSpinner).style.display = 'none';
        document.querySelector(elements.printPreview).style.display = 'block';
        
        if (data.success) {
            // ä½¿ç”¨ç§»åŠ¨ç«¯ä¼˜åŒ–çš„é¢„è§ˆæ˜¾ç¤º
            if (isMobile && window.mobileUtils) {
                window.mobileUtils.optimizePrintPreviewForMobile(data.image_url);
            } else {
                document.querySelector(elements.printPreview).innerHTML = 
                    `<img src="${data.image_url}" alt="æ‰“å°é¢„è§ˆ" class="img-fluid">`;
            }
            
            // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
            document.querySelector(elements.downloadBtn).style.display = 'inline-block';
            if (isMobile) {
                document.getElementById('mobileDownloadBtn').style.display = 'block';
            }
            
            // ç»‘å®šä¸‹è½½äº‹ä»¶
            const downloadHandler = () => {
                if (isMobile) {
                    // ç§»åŠ¨ç«¯ä½¿ç”¨æ”¹è¿›çš„ä¸‹è½½æ–¹æ³•
                    downloadImageForMobile(data.image_url, `${selectedReport.biz_name}_${new Date().getTime()}.png`);
                } else {
                    // æ¡Œé¢ç«¯ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                    const link = document.createElement('a');
                    link.href = data.image_url;
                    link.download = `${selectedReport.biz_name}_${new Date().getTime()}.png`;
                    link.click();
                }
            };
            
            document.querySelector(elements.downloadBtn).onclick = downloadHandler;
            if (isMobile) {
                document.getElementById('mobileDownloadBtn').onclick = downloadHandler;
            }
        } else {
            alert('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            resetPreview();
        }
    })
    .catch(error => {
        document.querySelector(elements.loadingSpinner).style.display = 'none';
        document.querySelector(elements.printPreview).style.display = 'block';
        alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
        console.error('Error:', error);
        resetPreview();
    });
}

// ç»‘å®šç”ŸæˆæŒ‰é’®äº‹ä»¶
document.querySelector(elements.generateBtn).addEventListener('click', generatePrint);
if (isMobile) {
    document.getElementById('mobileGenerateBtn').addEventListener('click', generatePrint);
}

// ç§»åŠ¨ç«¯ä¸‹è½½å›¾ç‰‡åŠŸèƒ½
function downloadImageForMobile(imageUrl, filename) {
    try {
        // å°è¯•æ ‡å‡†ä¸‹è½½æ–¹æ³•
        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = filename;
        
        // æ£€æŸ¥æ˜¯å¦æ”¯æŒdownloadå±æ€§
        if (typeof link.download !== 'undefined') {
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showMobileDownloadTip('success');
        } else {
            // ä¸æ”¯æŒdownloadå±æ€§ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            fallbackDownload(imageUrl);
        }
    } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        fallbackDownload(imageUrl);
    }
}

// å¤‡ç”¨ä¸‹è½½æ–¹æ¡ˆ
function fallbackDownload(imageUrl) {
    try {
        // åœ¨æ–°çª—å£æ‰“å¼€å›¾ç‰‡
        const newWindow = window.open(imageUrl, '_blank');
        if (newWindow) {
            // æ˜¾ç¤ºé•¿æŒ‰ä¿å­˜æç¤º
            showMobileDownloadTip('longpress');
        } else {
            // æ–°çª—å£è¢«é˜»æ­¢ï¼Œç›´æ¥è·³è½¬
            window.location.href = imageUrl;
            showMobileDownloadTip('longpress');
        }
    } catch (error) {
        console.error('å¤‡ç”¨ä¸‹è½½æ–¹æ¡ˆå¤±è´¥:', error);
        showMobileDownloadTip('error');
    }
}

// æ˜¾ç¤ºç§»åŠ¨ç«¯ä¸‹è½½æç¤º
function showMobileDownloadTip(type) {
    let message = '';
    let alertClass = '';
    
    switch (type) {
        case 'success':
            message = 'å›¾ç‰‡ä¸‹è½½å·²å¼€å§‹ï¼Œè¯·æŸ¥çœ‹ä¸‹è½½æ–‡ä»¶å¤¹';
            alertClass = 'alert-success';
            break;
        case 'longpress':
            message = 'ğŸ’¡ æç¤ºï¼šåœ¨æ‰“å¼€çš„å›¾ç‰‡ä¸Š<strong>é•¿æŒ‰å›¾ç‰‡</strong>ï¼Œç„¶åé€‰æ‹©"ä¿å­˜å›¾ç‰‡"æˆ–"ä¸‹è½½å›¾ç‰‡"';
            alertClass = 'alert-info';
            break;
        case 'error':
            message = 'ä¸‹è½½å¤±è´¥ï¼Œè¯·å°è¯•é•¿æŒ‰å›¾ç‰‡ä¿å­˜';
            alertClass = 'alert-warning';
            break;
    }
    
    // åˆ›å»ºæç¤ºæ¡†
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show mobile-download-tip`;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 15px;
        right: 15px;
        z-index: 9999;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="å…³é—­"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // è‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.classList.remove('show');
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    document.body.removeChild(alertDiv);
                }
            }, 300);
        }
    }, type === 'longpress' ? 8000 : 4000); // é•¿æŒ‰æç¤ºæ˜¾ç¤ºæ›´ä¹…
}

// è¿”å›é¡¶éƒ¨åŠŸèƒ½
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// ç§»åŠ¨ç«¯è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶æ»šåŠ¨åˆ°è§†å›¾
if (isMobile) {
    document.querySelector(elements.studentCode).addEventListener('focus', function() {
        setTimeout(() => {
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
    });
}

// æ˜¾ç¤ºç§»åŠ¨ç«¯æ“ä½œæ å½“æ»šåŠ¨åˆ°ä¸€å®šä½ç½®æ—¶
if (isMobile) {
    let actionBarTimeout;
    window.addEventListener('scroll', function() {
        const actionBar = document.getElementById('mobileActionBar');
        if (actionBar && actionBar.style.display !== 'none') {
            actionBar.style.opacity = '1';
            actionBar.style.transform = 'translateY(0)';
            
            clearTimeout(actionBarTimeout);
            actionBarTimeout = setTimeout(() => {
                if (window.scrollY > 200) {
                    actionBar.style.opacity = '0.8';
                    actionBar.style.transform = 'translateY(50%)';
                }
            }, 2000);
        }
    });
}
</script>

<style>
/* ç§»åŠ¨ç«¯ä¸“ç”¨æ ·å¼ */
.mobile-print-container {
    max-width: 100%;
    margin: 0 auto;
}

.mobile-action-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid #dee2e6;
    padding: 10px;
    z-index: 1000;
    transition: all 0.3s ease;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    body {
        padding-bottom: 140px; /* ä¸ºå›ºå®šåº•æ å’Œç‰ˆæƒä¿¡æ¯ç•™ç©ºé—´ */
    }
    
    .card {
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card-header {
        border-radius: 15px 15px 0 0 !important;
    }
    
    .btn-lg {
        padding: 15px 20px;
        font-size: 1.1rem;
    }
    
    .report-btn {
        border-radius: 12px;
        transition: all 0.2s ease;
    }
    
    .report-btn:active {
        transform: scale(0.98);
    }
    
    .mobile-print-preview {
        text-align: center;
    }
    
    .print-image-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 15px;
    }
    
    .print-actions button {
        border-radius: 10px;
        font-weight: 500;
    }
}

/* è§¦æ‘¸ä¼˜åŒ– */
@media (hover: none) and (pointer: coarse) {
    .report-btn:hover {
        background-color: inherit;
        border-color: inherit;
    }
    
    .report-btn:active {
        background-color: #287042;
        border-color: #287042;
        color: white;
    }
}
</style>
{% endblock %} 